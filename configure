#!/bin/sh

#
# Default options
#
app=magicrescue
prefix=/usr/local
env_vars="CC CFLAGS CPPFLAGS LDFLAGS"
def_CC=cc
def_CFLAGS="-O3 -Wall"

MAKE_VARS="EXE"
EXE=

#
# Helper functions
#

echo1() { echo $ECHO_N "$1$ECHO_C"; }
echo2() { echo "$ECHO_T$1"; }

conftest() {
    $CC $CPPFLAGS $CFLAGS -o conftest $LDFLAGS conftest.c >/dev/null 2>&1 \
	|| return 1
    ./conftest
}

conftest_define() {
    echo1 "$2"
    if conftest; then
	echo "#define $1 1" >> config.h
	echo2 "yes"
    else
	echo2 "no"
    fi
}

#
# Generate config.h
#
[ -d config.d ] || {
    echo "Directory config.d not found. Run configure from the source root."
    exit 1
}

rm -f config.h
cat > config.h << EOF
/* XXX This file automatically generated by configure. */

EOF

#
# Environment
#
for var in $env_vars; do
    eval "$var=\${$var:-\$def_$var}"
    export $var
done

#
# Parse arguments
#
for option; do
    case "$option" in

    --help)
	cat << EOF
This will configure $app for your system.

Options:
  --prefix=DIR    Path to install under [$prefix]
  CC=COMMAND      C compiler to use [$CC]
  CFLAGS=OPTIONS  C compiler flags [$CFLAGS]
EOF
	exit
	;;

    --strict)
	export CFLAGS="$CFLAGS -std=c9x -W -Wshadow -Wpointer-arith -Wstrict-prototypes -Wmissing-prototypes -Wredundant-decls"
	;;

    --*=*)
	arg=`echo "$option"|cut -d= -f 2`
	case "$option" in
	--prefix=*)
	    prefix="$arg"
	    ;;
	*)
	    echo "configure: warning: ignoring option $option"
	    ;;
	esac
	;;

    *=*)
	export "$option"
    esac
done

#
# Do tests
#

# echo test, stolen from GNU autoconf. This really shows UNIX at its worst...
case `echo "testing\c"; echo 1,2,3`,`echo -n testing; echo 1,2,3` in
  *c*,-n*) ECHO_N= ECHO_C='
' ECHO_T='	' ;;
  *c*,*  ) ECHO_N=-n ECHO_C= ECHO_T= ;;
  *)       ECHO_N= ECHO_C='\c' ECHO_T= ;;
esac

for f in config.d/*; do
    . "$f"
done

rm -f conftest.c conftest

#
# Generate Makefile
#
rm -f Makefile 2>/dev/null || chmod 644 Makefile
cat > Makefile << EOF
# XXX This Makefile is automatically generated by configure.
# XXX Modify Makefile.in to change it.

PREFIX = $prefix
EOF

for var in $env_vars $MAKE_VARS; do
    eval "val=\"\$$var\""
    echo "$var = $val" >> Makefile
done

cat Makefile.in >> Makefile
chmod 444 Makefile

echo
echo "Done. Now type 'make' to compile"
